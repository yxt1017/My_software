<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€å›¾ç‰‡è½¬æ¢å™¨</title>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f4f7f6; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; width: 400px; }
        .drop-zone { border: 2px dashed #007bff; padding: 20px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; transition: background 0.3s; }
        .drop-zone:hover { background: #e7f3ff; }
        select, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        #preview { max-width: 100%; margin-top: 15px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ–¼ï¸ å›¾ç‰‡æ ¼å¼è½¬æ¢</h2>
    <div class="drop-zone" id="dropZone">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
    
    <div>
        <label>ç›®æ ‡æ ¼å¼ï¼š</label>
        <select id="formatSelect">
            <option value="image/png">PNG</option>
            <option value="image/jpeg">JPG</option>
            <option value="image/x-icon">ICO (Icon)</option>
            <option value="image/webp">WebP</option>
        </select>
    </div>
    
    <button id="convertBtn">è½¬æ¢å¹¶ä¸‹è½½</button>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="preview" alt="é¢„è§ˆ">
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const formatSelect = document.getElementById('formatSelect');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');

    let sourceImg = new Image();

    // è§¦å‘æ–‡ä»¶é€‰æ‹©
    dropZone.onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                sourceImg.src = event.target.result;
                sourceImg.onload = () => {
                    preview.src = sourceImg.src;
                    preview.style.display = 'inline-block';
                    dropZone.innerText = `å·²åŠ è½½: ${file.name}`;
                };
            };
            reader.readAsDataURL(file);
        }
    };

    convertBtn.onclick = () => {
        if (!sourceImg.src) return alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');

    const targetFormat = formatSelect.value;
    
    if (targetFormat !== 'image/x-icon') {
        canvas.width = sourceImg.width;
        canvas.height = sourceImg.height;
        canvas.getContext('2d').drawImage(sourceImg, 0, 0);
        downloadFile(canvas.toDataURL(targetFormat), `converted.${targetFormat.split('/')[1]}`);
        return;
    }

    // --- æ”¹è¿›ç‰ˆï¼šæ”¯æŒé«˜åˆ†è¾¨ç‡çš„ ICO è½¬æ¢ ---
    // è‡ªåŠ¨é€‚é…å›¾ç‰‡å°ºå¯¸ï¼Œæœ€é«˜æ”¯æŒ 256x256 (ICO æ ‡å‡†ä¸Šé™)
    const size = Math.min(Math.max(sourceImg.width, sourceImg.height), 256);
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');
    
    // å±…ä¸­ç»˜åˆ¶å›¾ç‰‡ï¼Œé˜²æ­¢å˜å½¢
    ctx.clearRect(0, 0, size, size);
    ctx.drawImage(sourceImg, 0, 0, size, size);

    canvas.toBlob((blob) => {
        blob.arrayBuffer().then(buffer => {
            const pngData = new Uint8Array(buffer);
            const icoHeaderSize = 6;
            const icoDirectorySize = 16;
            const totalSize = icoHeaderSize + icoDirectorySize + pngData.length;
            
            const icoBuffer = new ArrayBuffer(totalSize);
            const view = new DataView(icoBuffer);

            // 1. ICO Header
            view.setUint16(0, 0, true);
            view.setUint16(2, 1, true);
            view.setUint16(4, 1, true);

            // 2. Image Directory
            // æ³¨æ„ï¼šICO æ ‡å‡†è§„å®š 256px éœ€å†™å…¥ 0 è€Œé 256
            view.setUint8(6, size >= 256 ? 0 : size); 
            view.setUint8(7, size >= 256 ? 0 : size);
            view.setUint8(8, 0); 
            view.setUint8(9, 0);
            view.setUint16(10, 1, true);
            view.setUint16(12, 32, true);
            view.setUint32(14, pngData.length, true);
            view.setUint32(18, icoHeaderSize + icoDirectorySize, true);

            // 3. å†™å…¥æ•°æ®
            const finalImage = new Uint8Array(icoBuffer);
            finalImage.set(pngData, icoHeaderSize + icoDirectorySize);

            const finalBlob = new Blob([finalImage], { type: 'image/x-icon' });
            downloadFile(URL.createObjectURL(finalBlob), 'app_icon.ico');
            console.log(`è½¬æ¢å®Œæˆï¼Œå°ºå¯¸: ${size}x${size}, å¤§å°: ${(totalSize/1024).toFixed(2)} KB`);
        });
    }, 'image/png');
};

function downloadFile(url, fileName) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click();
};
</script>

</body>
</html>
